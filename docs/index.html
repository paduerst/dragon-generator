<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- <link rel="icon" href="images/favicon.png"/> -->
    <title>Prismatic Dragon Generator</title>
    <meta property="og:title" content="Prismatic Dragons">
    <meta property="og:type" content="website">
    <meta property="og:description" content="Prismatic Dragon Generator, for private use only.">
    <!-- <meta property="og:image" content="images/preview.png"> -->
    <meta property="og:url" content="https://dragon.palladiumturtle.com/">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:400,400i,700,700i|Alegreya+Sans+SC:700">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns" crossorigin="anonymous"></script></head>
</head>

<body>

  <noscript>It appears that your browser does not support JavaScript, which is necessary for this page to work! You may have a browser extension which disables JavaScript.</noscript>

  <div class='customization-menu'>
    <div class="accordion" id="accordionExample">

      <h2 class="mb-0">
        <button class="btn btn-link btn-block text-light" type="button" data-toggle="collapse" data-target="#dragonMenu" aria-expanded="true" aria-controls="dragonMenu">
            Dragon Options Menu
        </button>
      </h2>

      <div id="dragonMenu" class="collapse bg-light"  data-parent="#accordionExample">
        <div class="card-body">
          <p><em>Welcome to the prismatic dragon stat block generator! Adjust the dragon traits using the form below, then click refresh to view the new stat block. You can save stat blocks by copying the link or by printing the page to a PDF.</em></p>
            
          <form>

            <div class="form-group row">
                <label for="age" class="col-md-2 col-form-label">Age</label>
                <div class="col-md-10">
                    <select class="form-control" id="age" name="age">
                        <option value="wyrmling">Wyrmling</option>
                        <option value="young">Young</option>
                        <option value="adult">Adult</option>
                        <option value="ancient">Ancient</option>
                    </select>
                </div>
            </div>

            <div class="form-group row">
                <label for="color" class="col-md-2 col-form-label">Color</label>
                <div class="col-md-10">
                    <select class="form-control" id="color" name="color">
                        <option value="red">Red</option>
                        <option value="orange">Orange</option>
                        <option value="yellow">Yellow</option>
                        <option value="green">Green</option>
                        <option value="blue">Blue</option>
                        <option value="indigo">Indigo</option>
                        <option value="violet">Violet</option>
                        <option value="magenta">Magenta</option>
                        <option value="white">White</option>
                    </select>
                </div>
            </div>

            <div class="form-group row">
                <label for="name" class="col-md-2 col-form-label">Name</label>
                <div class="col-md-10">
                    <input class="form-control" type="text" placeholder='Referred to as "the dragon" by default' id="name" name="name">
                </div>
            </div>

            <div class="form-group row">
                <label for="alignment" class="col-md-2 col-form-label">Alignment</label>
                <div class="col-md-10">
                    <input class="form-control" type="text" placeholder='Defaults to typical alignment for this color' id="alignment" name="alignment">
                </div>
            </div>

            <div class="form-group row">
              <label for="pronouns" class="col-md-2 col-form-label">Pronouns</label>
              <div class="col-md-10">
                  <select class="form-control" id="pronouns" name="pronouns">
                      <option value="neutral">It/It/Its</option>
                      <option selected value="feminine">She/Her/Her</option>
                      <option value="masculine">He/Him/His</option>
                      <option value="singularthey">They/Them/Their</option>
                      <option value="spivak">Ey/Em/Eir</option>
                  </select>
              </div>
            </div>

            <div class="form-group row">
                <legend class="col-form-label col-md-2 float-sm-left pt-0">Advanced Customization</legend>
                <div class="col-md-10">

                  <div class="custom-control custom-switch">
                    <input type="checkbox" class="custom-control-input" id="nosecondbreath" name="nosecondbreath">
                    <label class="custom-control-label" for="nosecondbreath">No Secondary Breath Weapon</label>
                  </div>

                  <div class="custom-control custom-switch">
                    <input type="checkbox" class="custom-control-input" id="nochangeshape" name="nochangeshape">
                    <label class="custom-control-label" for="nochangeshape">No Shape Change</label>
                  </div>

                  <div class="custom-control custom-switch">
                    <input type="checkbox" class="custom-control-input" id="nowallofcolor" name="nowallofcolor">
                    <label class="custom-control-label" for="nowallofcolor">No Wall of Prismatic Color</label>
                  </div>

                  <div class="custom-control custom-switch">
                    <input type="checkbox" class="custom-control-input" id="noleveledspells" name="noleveledspells">
                    <label class="custom-control-label" for="noleveledspells">No leveled spells from Innate Spellcasting</label>
                  </div>

                  <div class="custom-control custom-switch">
                    <input type="checkbox" class="custom-control-input" id="usealtvulnerability" name="usealtvulnerability">
                    <label class="custom-control-label" for="usealtvulnerability">Use Alternative Vulnerability</label>
                  </div>

                  <div class="custom-control custom-switch">
                    <input type="checkbox" class="custom-control-input" id="forcesinglecolumn" name="forcesinglecolumn">
                    <label class="custom-control-label" for="forcesinglecolumn">Force Single-Column Stat Block</label>
                  </div>

                  <div class="custom-control custom-switch">
                    <input type="checkbox" class="custom-control-input" id="usestandardtheme" name="usestandardtheme">
                    <label class="custom-control-label" for="usestandardtheme">Force Standard Stat Block Theme</label>
                  </div>

                  <div class="custom-control custom-switch">
                    <input type="checkbox" class="custom-control-input" id="printcropped" name="printcropped">
                    <label class="custom-control-label" for="printcropped">Crop to Statblock (Except Bottom) for Printing</label>
                  </div>

                </div>
              </div>

            <!-- <fieldset class="form-group row">
            <legend class="col-form-label col-md-2 float-sm-left pt-0">Number of columns</legend>
            <div class="col-md-10">
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="columns" id="columns1" value="1">
                <label class="form-check-label" for="columns1">1</label>
              </div>
              <div class="form-check form-check-inline">
                <input checked class="form-check-input" type="radio" name="columns" id="columns2" value="2">
                <label class="form-check-label" for="columns2">2</label>
              </div>
            </div>
            </fieldset> -->

            <div class="form-group row">
                <div class="col-md-10">
                    <button type="submit" class="btn btn-primary">Refresh</button>
                </div>
            </div>

          </form>

        </div>
      </div>

    </div>
  </div>

  <div id="dragon-destination">
    <p>Loading...</p>
    <p>If this doesn't load after a couple of seconds, something is wrong.</p>
  </div>

  <style type="text/css" media="print" id="print-cropped-style"></style>
</body>

<script>
  // imported data
  var dragons;
  var templates;
  // end of imported data

  // non-imported consts
  const urlParams = new URLSearchParams(window.location.search);

  const supported_ages = [
    "wyrmling",
    "young",
    "adult",
    "ancient"
  ];

  const supported_colors = [
    "red",
    "orange",
    "yellow",
    "green",
    "blue",
    "indigo",
    "violet",
    "magenta",
    "white"
  ];

  const css_color_themes = {
    "Red": [154, 21, 21],
    "Orange": [156, 87, 14],
    "Yellow": [143, 133, 1],
    "Green": [28, 128, 0],
    "Blue": [0, 100, 150],
    "Indigo": [31, 0, 156],
    "Violet": [118, 43, 158],
    "Magenta": [173, 12, 117],
    "White": [127, 128, 119]
  };

  const global_skills = [
    {"skill": "Acrobatics", "ability": "dex"},
    {"skill": "Animal Handling", "ability": "wis"},
    {"skill": "Arcana", "ability": "int"},
    {"skill": "Athletics", "ability": "str"},
    {"skill": "Deception", "ability": "cha"},
    {"skill": "History", "ability": "int"},
    {"skill": "Insight", "ability": "wis"},
    {"skill": "Intimidation", "ability": "cha"},
    {"skill": "Investigation", "ability": "int"},
    {"skill": "Medicine", "ability": "wis"},
    {"skill": "Nature", "ability": "int"},
    {"skill": "Perception", "ability": "wis"},
    {"skill": "Performance", "ability": "cha"},
    {"skill": "Persuasion", "ability": "cha"},
    {"skill": "Religion", "ability": "int"},
    {"skill": "Sleight of Hand", "ability": "dex"},
    {"skill": "Stealth", "ability": "dex"},
    {"skill": "Survival", "ability": "wis"}
  ];
  // end of non-imported consts

  // library for css customization
  function setMonstersColor(r_val, g_val, b_val) {
    var monsters = document.getElementsByClassName("monster");
    for (let i = 0; i < monsters.length; i++) {
      setMonsterColor(monsters[i], r_val, g_val, b_val);
    }
  }

  function setMonsterColor(monster, r_val, g_val, b_val) {
    if (monster === undefined) {
      monster = document.getElementsByClassName("monster")[0];
    }
    const rgba_prefix = "rgba(" + r_val + ", " + g_val + ", " + b_val + ", ";

    monster.style["border-color"] = rgba_prefix + "1.0)";

    var h4s = monster.getElementsByTagName("h4");
    for (let i = 0; i < h4s.length; i++) {
      h4s[i].style.color = rgba_prefix + "1.0)";
    }

    var h5s = monster.getElementsByTagName("h5");
    for (let i = 0; i < h5s.length; i++) {
      h5s[i].style.color = rgba_prefix + "1.0)";
    }

    var abils = monster.getElementsByClassName("monster-abilities");
    for (let i = 0; i < abils.length; i++) {
      let abil_labels = abils[i].getElementsByClassName("label");
      for (let j = 0; j < abil_labels.length; j++) {
        abil_labels[j].style.color = rgba_prefix + "1.0)";
      }
    }

    var uls = monster.getElementsByTagName("ul");
    for (let i = 0; i < uls.length; i++) {
      let ul_labels = uls[i].getElementsByClassName("label");
      for (let j = 0; j < ul_labels.length; j++) {
        ul_labels[j].style.color = rgba_prefix + "1.0)";
      }
    }

    var hrs = monster.getElementsByTagName("hr");
    var start_opacity = "1.0";
    for (let i = 0; i < hrs.length; i++) {
      if (i == 0 || i == (hrs.length-1)) {
        start_opacity = "1.0";
      } else {
        start_opacity = "0.75";
      }
      hrs[i].style.background = "linear-gradient(to right, " + rgba_prefix + start_opacity + "), " + rgba_prefix + "0))";
    }

    var h5Borders = monster.getElementsByClassName("h5-border");
    for (let i = 0; i < h5Borders.length; i++) {
      h5Borders[i].style.background = "linear-gradient(to right, " + rgba_prefix + "0.75), " + rgba_prefix + "0))";
    }
  }
  // end of css customization library

  // main library
  // Normalizes a string, by removing all non-alphanumeric characters and using mixed case to separate words. The output will always start with a lower case letter.
  function normalizeHeader_(header) {
    var key = "";
    var upperCase = false;
    for (var i = 0; i < header.length; ++i) {
      var letter = header[i];
      if (letter == " " && key.length > 0) {
        upperCase = true;
        continue;
      }
      if (!isAlnum_(letter)) {
        continue;
      }
      if (key.length == 0 && isDigit_(letter)) {
        continue; // first character must be a letter
      }
      if (upperCase) {
        upperCase = false;
        key += letter.toUpperCase();
      } else {
        key += letter.toLowerCase();
      }
    }
    return key;
  }

  // Returns true if the character char is alphabetical, false otherwise.
  function isAlnum_(char) {
    return char >= 'A' && char <= 'Z' ||
      char >= 'a' && char <= 'z' ||
      isDigit_(char);
  }

  // Returns true if the character char is a digit, false otherwise.
  function isDigit_(char) {
    return char >= '0' && char <= '9';
  }

  function capitalizeFirstLetter(string) {
    return string.charAt(0).toUpperCase() + string.slice(1);
  }

  // Replaces markers in a templates string with values from an array.
  function insertVariablesToTemplate_(template, values) {
    var templateVars = template.match(/\$\{\"[^\"]+\"\}/g); // Search for all the variables to be replaced, for instance ${"Column name"}
    if (templateVars !== null) { // If there are no variable markers, just return the input template.
      for (var i = 0; i < templateVars.length; ++i) { // Replace variables with values from the data array.
        var variableData = values[normalizeHeader_(templateVars[i])]; // Returns the value from the object of the desired ID.
        template = template.replace(templateVars[i], variableData || ""); // If no value is available, replace with the empty string.
      }
    }
    return template;
  }

  function convertTagsToLinks_(strIn) {
    var tags = strIn.match(/[\[][^\/\]]{1,50}[\]][^\[\]]{1,50}[\[][^\]]{1,50}[\]]/g); // matches all DDB tags with contents
    if (tags === null) {
      return strIn; // If there are no tags, just return the input string.
    } else {
      for (var i = 0; i < tags.length; ++i) {
        var tag = tags[i];
        var firstBrackArr = tag.match(/[\[][^\/\]]{1,50}[\]]/g); // matches the first bracketed portion
        var firstBrack = firstBrackArr[0];
        var contentsArr = tag.match(/\[[^\/\]]{1,50}\][^\[\]]{1,50}(?=\[[^\]]{1,50}\])/g); // match all but last brack
        var contents = contentsArr[0];
        contents = contents.substring(firstBrack.length); // remove first brack from contents
        firstBrack = firstBrack.substring(1, firstBrack.length - 1); // remove the square brackets

        var contentsInURL;
        var link = '<a target="_blank" href="https://www.dndbeyond.com/';
        if (firstBrack == "spell") {
          contentsInURL = contents.toLowerCase().replace(/[ \/]/g, "-").replace(/[’']/, "");
          link = link + 'spells/';
        } else if (firstBrack == "skill") {
          contentsInURL = contents.charAt(0).toUpperCase() + contents.substring(1);
          link = link + 'sources/basic-rules/using-ability-scores#';
        } else if (firstBrack == "condition") {
          contentsInURL = contents.charAt(0).toUpperCase() + contents.substring(1);
          link = link + 'sources/basic-rules/appendix-a-conditions#';
        }
        link = link + contentsInURL + '">' + contents + '</a>';
        strIn = strIn.replace(tag, link); // Replace tag with the appropriate link
      }
      return strIn;
    }
  }

  function addUserSpecifiedValues(dragon) {
    // DM vs GM
    let dmgm = "DM";
    // not sure what the name of this urlParam should be. TODO: add this?
    dragon.dmgm = dmgm;

    // Number of Columns
    let number_of_columns = 2;
    if (urlParams.has("forcesinglecolumn")) {
      number_of_columns = 1;
      document.getElementById("forcesinglecolumn").checked=true;
    }
    // if (dragon.age == "Wyrmling") {
    //   number_of_columns = 1;
    // }
    // if (urlParams.has("columns")) {
    //   if (urlParams.get("columns") == 1) {
    //     number_of_columns = 1;
    //     // populate form with pronouns
    //     document.getElementById("columns1").checked = true;
    //     document.getElementById("columns2").checked = false;
    //   } else if (urlParams.get("columns") == 2) {
    //     number_of_columns = 2;
    //     // populate form with pronouns
    //     document.getElementById("columns1").checked = false;
    //     document.getElementById("columns2").checked = true;
    //   }
    // }
    dragon.numberOfColumns = number_of_columns;

    // The dragon vs Name
    let dragon_name = "the dragon";
    if (urlParams.has("name") && urlParams.get("name")!="") {
      dragon_name = urlParams.get("name");
      // populate form
      document.getElementById("name").value = dragon_name;
    }
    dragon.theDragonName = dragon_name;
    dragon.theDragonNameUpper = capitalizeFirstLetter(dragon_name);

    // Alignment
    if (urlParams.has("alignment") && urlParams.get("alignment")!="") {
      dragon.alignment = urlParams.get("alignment");
      // populate form
      document.getElementById("alignment").value = dragon.alignment;
    }

    // Pronouns
    let pronouns = "feminine";
    if (urlParams.has("pronouns")) {
      let input_pronouns = urlParams.get("pronouns");
      const supported_pronouns = ["neutral",
                                  "feminine",
                                  "masculine",
                                  "singularthey",
                                  "spivak"
      ];
      if (supported_pronouns.includes(input_pronouns)) {
        pronouns = input_pronouns;
      }
    }
    if (pronouns == "neutral") {
      // The default pronouns of most D&D 5e statblocks
      dragon.itshe = "it"; // nominative
      dragon.ither = "it"; // objective
      dragon.itsher = "its"; // possessive determiner
      // populate form with pronouns
      document.getElementById("pronouns").value = "neutral";
    } else if (pronouns == "feminine") {
      // Most prismatic dragons use these pronouns
      dragon.itshe = "she";
      dragon.ither = "her";
      dragon.itsher = "her";
      // populate form with pronouns
      document.getElementById("pronouns").value = "feminine";
    } else if (pronouns == "masculine") {
      // No known prismatic dragons use these pronouns
      dragon.itshe = "he";
      dragon.ither = "him";
      dragon.itsher = "his";
      // populate form with pronouns
      document.getElementById("pronouns").value = "masculine";
    } else if (pronouns == "singularthey") {
      // singular they
      dragon.itshe = "they";
      dragon.ither = "them";
      dragon.itsher = "their";
      // populate form with pronouns
      document.getElementById("pronouns").value = "singularthey";
    } else if (pronouns == "spivak") {
      // An example of nonbinary pronouns
      dragon.itshe = "ey";
      dragon.ither = "em";
      dragon.itsher = "eir";
      // populate form with pronouns
      document.getElementById("pronouns").value = "spivak";
    }
    dragon.itsheUpper = capitalizeFirstLetter(dragon.itshe);
    dragon.itherUpper = capitalizeFirstLetter(dragon.ither);
    dragon.itsherUpper = capitalizeFirstLetter(dragon.itsher);

    return dragon;
  }

  function addBackendCalculatedValues(dragon) {
    // These values are calculated in the Backend tab of my dragon spreadsheet
    // They were omitted from the dragons const to reduce its size
    // Proficiency Bonus
    var pb;
    if (dragon.cr < 5) {
      pb = 2;
    } else {
      pb = 1 + Math.ceil(dragon.cr/4);
    }
    dragon.proficiencyBonus = pb;

    // Ability Score Modifiers
    dragon.str = Math.floor((dragon.strength-10)/2);
    dragon.dex = Math.floor((dragon.dexterity-10)/2);
    dragon.con = Math.floor((dragon.constitution-10)/2);
    dragon.int = Math.floor((dragon.intelligence-10)/2);
    dragon.wis = Math.floor((dragon.wisdom-10)/2);
    dragon.cha = Math.floor((dragon.charisma-10)/2);
    var Mod;
    for (let mod of ["str", "dex", "con", "int", "wis", "cha"]) {
      if (dragon[mod] < 0) {
        dragon[mod + "WithSign"] = "-" + dragon[mod];
      } else {
        dragon[mod + "WithSign"] = "+" + dragon[mod];
      }
      Mod = capitalizeFirstLetter(mod);
      dragon["proficiency"+Mod] = dragon.proficiencyBonus + dragon[mod];
      dragon["saveDc"+Mod] = 8 + dragon.proficiencyBonus + dragon[mod];
    }

    // Hit Die
    var hitDie = 4;
    if (dragon.size == "Small") {
      hitDie = 6;
    } else if (dragon.size == "Medium") {
      hitDie = 8;
    } else if (dragon.size == "Large") {
      hitDie = 10;
    } else if (dragon.size == "Huge") {
      hitDie = 12;
    } else if (dragon.size == "Gargantuan") {
      hitDie = 20;
    }
    dragon.hitDie = hitDie;

    // Hit Points
    dragon.expectedHitPoints = Math.floor(dragon.numberOfHitDice*(0.5 + dragon.hitDie/2 + dragon.con));
    dragon.hpConMod = dragon.numberOfHitDice*dragon.con;

    // Passive Skills
    dragon.passiveInsight = 10 + dragon.wis + dragon.skillInsight*dragon.proficiencyBonus;
    dragon.passiveInvestigation = 10 + dragon.int + dragon.skillInvestigation*dragon.proficiencyBonus;
    dragon.passivePerception = 10 + dragon.wis + dragon.skillPerception*dragon.proficiencyBonus;

    // Expected Damages
    dragon.biteExpectedDamage = Math.floor(dragon.biteDiceCount*(0.5+dragon.biteDiceType/2) + dragon.str);
    dragon.biteElementExpectedDamage = Math.floor(dragon.biteElementDiceCount*(0.5+dragon.biteElementDiceType/2));
    dragon.clawExpectedDamage = Math.floor(dragon.clawDiceCount*(0.5+dragon.clawDiceType/2) + dragon.str);
    dragon.tailExpectedDamage = Math.floor(dragon.tailDiceCount*(0.5+dragon.tailDiceType/2) + dragon.str);
    dragon.breath1ExpectedDamage = Math.floor(dragon.breath1DiceCount*(0.5+dragon.breath1DiceType/2));
    dragon.wingAttackExpectedDamage = Math.floor(dragon.wingAttackDiceCount*(0.5+dragon.wingAttackDiceType/2) + dragon.str);

    return dragon;
  }

  function addGeneralDragonStatistics(dragon) {
    // Dragon Title
    if (dragon.age == "Wyrmling") {
      dragon.dragonTitle = "" + dragon.color + " Dragon " + dragon.age;
    } else {
      dragon.dragonTitle = "" + dragon.age + " " + dragon.color + " Dragon";
    }
    if (dragon.theDragonName != "the dragon") {
      dragon.dragonTitle = dragon.theDragonName + " (" + dragon.dragonTitle + ")";
    }

    // Speeds
    let speeds = "" + dragon.walkingSpeed + " ft.";
    if (dragon.burrowSpeed > 0) {
      speeds = speeds + ", burrow " + dragon.burrowSpeed + " ft.";
    }
    if (dragon.climbSpeed > 0) {
      speeds = speeds + ", climb " + dragon.climbSpeed + " ft.";
    }
    if (dragon.flyingSpeed > 0) {
      speeds = speeds + ", fly " + dragon.flyingSpeed + " ft.";
    }
    if (dragon.swimSpeed > 0) {
      speeds = speeds + ", swim " + dragon.swimSpeed + " ft.";
    }
    dragon.speeds = speeds;

    // Saving Throws
    // all prismatic dragons have proficiency in DEX, CON, WIS, and CHA saves
    // assume none of the saving throw mods (with proficiency) are negative
    dragon.savingThrows = "DEX +" + dragon.proficiencyDex +
                          ", CON +" + dragon.proficiencyCon +
                          ", WIS +" + dragon.proficiencyWis +
                          ", CHA +" + dragon.proficiencyCha;

    // Skills
    let skills_arr = [];
    var skill_key;
    var skill_prof;
    var skill_mod;
    var skill_sign;
    for (let i = 0; i < global_skills.length; i++) {
      skill_key = normalizeHeader_("Skill " + global_skills[i].skill);
      skill_prof = dragon[skill_key];
      if (skill_prof > 0) {
        skill_mod = dragon[global_skills[i].ability] +
                    skill_prof*dragon.proficiencyBonus;
        if (skill_mod < 0) {
          skill_sign = "-";
        } else {
          skill_sign = "+";
        }
        skills_arr.push(global_skills[i].skill + " " + skill_sign + skill_mod);
      }
    }
    for (let i = 0; i < skills_arr.length; i++) {
      skills_arr[i] = "<span class=\"nowrap\">" + skills_arr[i] + "</span>";
    }
    dragon.skills = skills_arr.join(", ");

    // Cantrip
    const spell_prefix = "<i>[spell]";
    const spell_suffix = "[/spell]</i>";
    dragon.cantrip = spell_prefix + dragon.rawCantrip + spell_suffix;

    // Spells
    let spells_arr = dragon.rawSpells.split(",");
    var spell_arr;
    var spell;
    var parenthetical;
    for (let i = 0; i < spells_arr.length; i++) {
      spell_arr = spells_arr[i].split("(");
      spell = spell_arr[0].trim();
      if (spell_arr.length > 1) {
        parenthetical = " (" + spell_arr[1].trim();
      } else {
        parenthetical = "";
      }
      spells_arr[i] = spell_prefix + spell + spell_suffix + parenthetical;
    }
    dragon.spells = spells_arr.sort().join(", ");

    return dragon;
  }

  function addCaseVariants(dragon) {
    const vals_to_vary = [
      "immunity",
      "immunities",
      "resistances",
      "vulnerability",
      "color",
      "age"
    ];
    for (let val of vals_to_vary) {
      dragon[val + "Upper"] = capitalizeFirstLetter(dragon[val]);
      dragon[val + "Lower"] = dragon[val].toLowerCase();
      dragon[val + "Caps"] = dragon[val].toUpperCase();
    }
    return dragon
  }

  function generateFeaturesArray_(dragon) {
    var out_arr = [];

    if (dragon.amphibious > 0) {
      out_arr.push(insertVariablesToTemplate_(templates.amphibious, dragon));
    }

    if (dragon.iceWalk > 0) {
      out_arr.push(insertVariablesToTemplate_(templates.iceWalk, dragon));
    }

    // Innate Spellcasting
    if (dragon.age == "Wyrmling" || urlParams.has("noleveledspells")) {
      out_arr.push(insertVariablesToTemplate_(templates.innateSpellcastingDescriptionWyrmling, dragon));
      out_arr.push(insertVariablesToTemplate_(templates.innateSpellcastingCantrip, dragon));
      if (urlParams.has("noleveledspells")) {
        // populate form
        document.getElementById("noleveledspells").checked = true;
      }
    } else {
      out_arr.push(insertVariablesToTemplate_(templates.innateSpellcastingDescriptionAdult, dragon));
      out_arr.push(insertVariablesToTemplate_(templates.innateSpellcastingCantrip, dragon));
      out_arr.push(insertVariablesToTemplate_(templates.innateSpellcastingSpells, dragon));
    }

    if (dragon.legendaryResistances > 0) {
      out_arr.push(insertVariablesToTemplate_(templates.legendaryResistance, dragon));
    }

    out_arr.push(insertVariablesToTemplate_(templates.magicResistance, dragon));

    if (dragon.legendaryResistances > 0) {
      out_arr.push(insertVariablesToTemplate_(templates.magicWeapons, dragon));
    }

    if (urlParams.has("usealtvulnerability")) {
      let features_lost = "Innate Spellcasting, Magic Resistance, ";
      if (urlParams.has("nowallofcolor") || !((dragon.age == "Adult" || dragon.age == "Ancient") && dragon.color != "White")) {
        features_lost = features_lost + "and Variable Radiance";
      } else {
        features_lost = features_lost + "Variable Radiance, and Wall of Prismatic " + dragon.colorUpper;
      }
      dragon.altVulnerabilityFeaturesLost = features_lost;
      out_arr.push(insertVariablesToTemplate_(templates["altVulnerability" + dragon_color], dragon));
      // populate form
      document.getElementById("usealtvulnerability").checked = true;
    }

    return out_arr;
  }

function generateActionsArray_(dragon) {
  var out_arr = [];

  // Multiattack
  if (dragon.age == "Wyrmling") {
    // no multiattack
  } else if (dragon.age == "Young") {
    out_arr.push(insertVariablesToTemplate_(templates.multiattackYoung, dragon));
  } else {
    out_arr.push(insertVariablesToTemplate_(templates.multiattackAdult, dragon));
  }
  out_arr.push(insertVariablesToTemplate_(templates.bite, dragon));
  if (dragon.clawReach > 0) {
    out_arr.push(insertVariablesToTemplate_(templates.claw, dragon));
  }
  if (dragon.tailReach > 0) {
    out_arr.push(insertVariablesToTemplate_(templates.tail, dragon));
  }
  if (dragon.age == "Adult" || dragon.age == "Ancient") {
    out_arr.push(insertVariablesToTemplate_(templates.frightfulPresence, dragon));
  }

  // Breath Weapons
  let breathColor = "breath" + dragon.colorUpper;
  if (urlParams.has("nosecondbreath")) {
    out_arr.push(insertVariablesToTemplate_(templates[breathColor + "Wyrmling"], dragon));
    // populate form to reflect no second breath
    document.getElementById("nosecondbreath").checked=true;
  } else {
    // out_arr.push(insertVariablesToTemplate_(templates.breathPrefix, dragon));
    out_arr.push(insertVariablesToTemplate_(templates[breathColor + "1"], dragon));
    if (dragon.color != "Violet") {
      out_arr.push(insertVariablesToTemplate_(templates[breathColor + "2"], dragon));
    } else {
      let breathStart = insertVariablesToTemplate_(templates[breathColor + "2"], dragon);
      let breathEnd;
      if (dragon.age == "Adult" || dragon.age == "Ancient") {
        breathEnd = insertVariablesToTemplate_(templates[breathColor + "2EndAdult"], dragon)
      } else {
        breathEnd = insertVariablesToTemplate_(templates[breathColor + "2EndYoung"], dragon)
      }
      out_arr.push(breathStart + breathEnd);
    }
  }

  // Wall of Prismatic Color
  if (urlParams.has("nowallofcolor")) {
    // no wall of color
    // populate form to reflect no wall of color
    document.getElementById("nowallofcolor").checked=true;
  } else if ((dragon.age == "Adult" || dragon.age == "Ancient") && dragon.color != "White") {
    out_arr.push(insertVariablesToTemplate_(templates.wallOfPrismaticColorNew, dragon));
  }

  return out_arr;
}

function generateBonusActionsArray_(dragon) {
  var out_arr = [];

  // Change Shape
  if (urlParams.has("nochangeshape")) {
    // no change shape
    // populate form to reflect no change shape
    document.getElementById("nochangeshape").checked=true;
  } else if (dragon.age == "Adult" || dragon.age == "Ancient") {
    out_arr.push(insertVariablesToTemplate_(templates.changeShape, dragon));
  }

  out_arr.push(insertVariablesToTemplate_(templates.prismaticRadiance, dragon));

  return out_arr;
}
  // end of main library

  function generateDragon() {
    // specify type of dragon
    var dragon_color = "Red";
    var input_color;
    if (urlParams.has("color")) {
      input_color = urlParams.get("color").trim().toLowerCase();
      if (supported_colors.includes(input_color)) {
        dragon_color = capitalizeFirstLetter(input_color);
      }
    }
    var dragon_age = "Young";
    var input_age;
    if (urlParams.has("age")) {
      input_age = urlParams.get("age").trim().toLowerCase();
      if (supported_ages.includes(input_age)) {
        dragon_age = capitalizeFirstLetter(input_age);
      }
    }
    // end of dragon specification

    // populate form with current values
    document.getElementById("color").value = dragon_color.toLowerCase();
    document.getElementById("age").value = dragon_age.toLowerCase();

    // generate the dragon statblock
    var dragon_key = normalizeHeader_(dragon_color + " " + dragon_age);
    var dragon = dragons[dragon_key];

    // add the other dragon values needed
    dragon = addUserSpecifiedValues(dragon);
    dragon = addBackendCalculatedValues(dragon);
    dragon = addGeneralDragonStatistics(dragon);
    dragon = addCaseVariants(dragon);

    // start constructing the output array of strings of HTML
    var out_arr = [];
    out_arr.push(insertVariablesToTemplate_(templates.htmlMonsterStart, dragon));
    out_arr.push(insertVariablesToTemplate_(templates.htmlMonsterHeader, dragon));
    out_arr.push(insertVariablesToTemplate_(templates.htmlAcHpSpeeds, dragon));
    out_arr.push(insertVariablesToTemplate_(templates.htmlAbilityScores, dragon));

    out_arr.push(insertVariablesToTemplate_(templates.htmlMonsterStatsStart, dragon));
    out_arr.push(insertVariablesToTemplate_(templates.htmlMonsterStatSaves, dragon));
    out_arr.push(insertVariablesToTemplate_(templates.htmlMonsterStatSkills, dragon));
    if (!urlParams.has("usealtvulnerability")) {
      out_arr.push(insertVariablesToTemplate_(templates.htmlMonsterStatVulnerabilities, dragon));
    }
    if (dragon.age == "Adult")
    {
      out_arr.push(insertVariablesToTemplate_(templates.htmlMonsterStatResistances, dragon));
    }
    out_arr.push(insertVariablesToTemplate_(templates.htmlMonsterStatImmunities, dragon));
    out_arr.push(insertVariablesToTemplate_(templates.htmlMonsterStatSenses, dragon));
    out_arr.push(insertVariablesToTemplate_(templates.htmlMonsterStatLanguages, dragon));
    out_arr.push(insertVariablesToTemplate_(templates.htmlMonsterStatChallenge, dragon));
    out_arr.push(insertVariablesToTemplate_(templates.htmlMonsterStatsEnd, dragon));

    out_arr.push(insertVariablesToTemplate_(templates.htmlTitleTraits, dragon));
    out_arr = out_arr.concat(generateFeaturesArray_(dragon));

    out_arr.push(insertVariablesToTemplate_(templates.htmlTitleActions, dragon));
    var actionsArray = generateActionsArray_(dragon);
    for (let i = 0; i < actionsArray.length; i++) {
      out_arr.push(actionsArray[i]);
      if (i == 0) {
        out_arr.push(templates.htmlDivEnd);
      }
    }

    out_arr.push(insertVariablesToTemplate_(templates.htmlTitleBonusActions, dragon));
    var bonusActionsArray = generateBonusActionsArray_(dragon);
    for (let i = 0; i < bonusActionsArray.length; i++) {
      out_arr.push(bonusActionsArray[i]);
      if (i == 0) {
        out_arr.push(templates.htmlDivEnd);
      }
    }

    if (dragon.legendaryResistances > 0) {
      out_arr.push(insertVariablesToTemplate_(templates.htmlTitleLegendaryActions, dragon));
      out_arr.push(insertVariablesToTemplate_(templates.legendaryDescription, dragon));
      out_arr.push(insertVariablesToTemplate_(templates.legendaryDetect, dragon));
      out_arr.push(insertVariablesToTemplate_(templates.legendaryTailAttack, dragon));
      out_arr.push(insertVariablesToTemplate_(templates.legendaryWingAttack, dragon));
    }

    out_arr.push(insertVariablesToTemplate_(templates.htmlMonsterEnd, dragon));
    var output = out_arr.join("\n");
    output = convertTagsToLinks_(output);
    document.getElementById("dragon-destination").innerHTML = output;
    // end of dragon statblock generation

    // change stat block colors to match dragon color
    if (urlParams.has("usestandardtheme")) {
      // use standard theme
      document.getElementById("usestandardtheme").checked=true;
    } else {
      let new_theme = css_color_themes[dragon_color];
      setMonstersColor(new_theme[0], new_theme[1], new_theme[2]);
    }

    // modify grammatical tense for singular they
    if (dragon.itshe == "they") {
      var affected_spans = document.getElementsByClassName("affected-by-they");
      for (let i = 0; i < affected_spans.length; i++) {
        let affected_span = affected_spans[i];
        affected_span.innerHTML = affected_span.getAttribute("data-they");
      }
    }

    // make page look like it would if you were printing
    if (urlParams.has("printpreview")) {
      var all_links = document.getElementsByTagName('a');
      for (let i = 0; i < all_links.length; i++) {
        let link_i = all_links[i];
        link_i.style.color = 'black';
        link_i.style.textDecoration = 'none !important';
      }
      var all_monsters = document.getElementsByClassName('monster');
      for (let i = 0; i < all_monsters.length; i++) {
        let monster_i = all_monsters[i];
        monster_i.style.borderWidth = '2px';
        monster_i.style.borderTopWidth = '5px';
        monster_i.style.borderBottomWidth = '5px';
        monster_i.style.width = '100%';
      }
      document.getElementsByClassName("customization-menu")[0].style.display = "none";
    }

    // update style so it prints just the statblock
    if (urlParams.has("printcropped")) {
        document.getElementById("printcropped").checked=true;
      var print_style = '@page {size: 900px 1500px; margin: 0px;}';
      var print_element  = $('#print-cropped-style');
      print_element.text(print_style);
    }
  }

  // import dragons and templates from JSON files
  function importDragons() {
    var request = new XMLHttpRequest();
    request.open("GET", "data/dragon_vals.json", true);
    request.send(null);
    request.onreadystatechange = function() {
      if ( request.readyState === 4 && request.status === 200 ) {
        dragons = JSON.parse(request.responseText);
        console.log(dragons);
        importTemplates();
      }
    }
  }

  function importTemplates() {
    var request = new XMLHttpRequest();
    request.open("GET", "data/feature_templates.json", true);
    request.send(null);
    request.onreadystatechange = function() {
      if ( request.readyState === 4 && request.status === 200 ) {
        templates = JSON.parse(request.responseText);
        console.log(templates);
        generateDragon();
      }
    }
  }

  // import values then generate the dragon
  importDragons();
</script>

<style>
body {
  background-color: #282a36;
}
.breath-break {
  line-height: 1.9em;
}
.nowrap {
    white-space: nowrap;
}
.monster + .monster {
  margin-top: 1em;
}
.monster {
  border-style: solid;
  border-width: 0px;
  border-color: rgba(154, 21, 21, 1.0);
  font-size: 0.875rem;
  position: relative;
  width: 28.6em;
  box-shadow: 0px 5px 10px 0px #50576240;
  display: flex;
  flex-direction: column; }
  .monster > :first-child {
    margin-top: 0; }
  .monster > :last-child {
    margin-bottom: 0; }
  .monster .monster-contents {
    width: 100%; }
    .monster .monster-contents .monster-contents-body {
      padding: 1.42em;
      background: white; }
  .monster .monster-header {
    display: inline-flex;
    width: 100%;
    justify-content: space-between;
    align-items: flex-end; }
    .monster .monster-header h4 {
      font-weight: bold;
      color: rgba(154, 21, 21, 1.0);
      margin: 0;
      line-height: 1;
      font-size: 2em;
      font-family: "Alegreya Sans SC", sans-serif;
      margin-top: -0.1em; }
    .monster .monster-header p {
      margin: 0; }
    .monster .monster-header .monster-description {
      font-style: italic;
      font-size: 0.8em; }
      .monster .monster-header .monster-description span:first-of-type {
        display: inline-block; }
        .monster .monster-header .monster-description span:first-of-type::first-letter {
          text-transform: uppercase; }
      .monster .monster-header .monster-description span + span::before {
        content: " "; }
      .monster .monster-header .monster-description * + .alignment::before {
        content: ", "; }
  .monster .discrete-element {
    display:inline-block; }
  .monster .monster-ac,
  .monster .monster-hp,
  .monster .monster-speed,
  .monster .monster-saves,
  .monster .monster-skills,
  .monster .monster-languages,
  .monster .monster-senses,
  .monster .monster-immunities,
  .monster .monster-vulnerabilities,
  .monster .monster-resistances,
  .monster .monster-conditions,
  .monster .monster-challenge {
    display: flex;
    flex-wrap: wrap; }
  .monster h5 {
    font-weight: bold;
    color: rgba(154, 21, 21, 1.0);
    font-family: "Alegreya Sans SC", sans-serif;
    display: inline-block;
    width: 100%;
    margin-bottom: 0;
    font-size: 1.45em;
    margin-top: 0.36em !important; }
    .monster h5 + * {
      margin-top: 0.52em; }
  .monster hr {
    margin: 0.285em 0 0;
    width: 100%;
    min-height: 1px;
    height: 0.143em;
    border: 0;
    background: linear-gradient(to right, rgba(154, 21, 21, 0.75), rgba(154, 21, 21, 0));
    -webkit-column-break-inside: avoid;
    -webkit-print-color-adjust: exact;
    page-break-inside: avoid;
    break-inside: avoid; }
    .monster hr:first-of-type, .monster hr:last-of-type {
      height: 0.2143em;
      background: linear-gradient(to right, rgba(154, 21, 21, 1.0), rgba(154, 21, 21, 0)); }
    .monster hr + * {
      margin-top: 0.285em; }
    .monster hr:last-of-type + * {
      margin-top: 0.57em; }
  .monster .label {
    font-weight: bold; }
  .monster .monster-abilities {
    display: inline-grid;
    width: 100%;
    grid-template-columns: repeat(6, 1fr);
    text-align: center;
    line-height: 1.4; }
    .monster .monster-abilities .label {
      color: rgba(154, 21, 21, 1.0);
      display: block;
      text-transform: uppercase; }
  .monster ul {
    list-style: none;
    padding: 0;
    margin-bottom: 0; }
    .monster ul .label {
      color: rgba(154, 21, 21, 1.0); }
    .monster ul li > p {
      margin: 0; }
  .monster p {
    margin-bottom: 0; }
    .monster p + * {
      margin-top: 0.57em; }
  .monster .monster-trait + *,
  .monster .monster-spells + *:not(.monster-spells),
  .monster .discrete-element + *,
  .monster .monster-action + *,
  .monster .monster-reaction + *,
  .monster .monster-legendary-action + *:not(.monster-legendary-action),
  .monster .monster-lair-action + * {
    margin-top: 0.57em; }
  .monster .monster-list p,
  .monster .monster-stats li p,
  .monster .monster-legendary-action p {
    text-indent: -1em; 
    padding-left: 1em; }
  .monster .monster-trait p + *,
  .monster .monster-action p + *,
  .monster .monster-reaction p + *,
  .monster .monster-legendary-action p + *,
  .monster .monster-lair-action p + * {
    margin-top: 0.57em; }
  .monster .monster-trait .name,
  .monster .monster-action .name,
  .monster .monster-reaction .name,
  .monster .monster-legendary-action .name,
  .monster .monster-lair-action .name {
    font-weight: bold;
    font-style: italic; }
  .monster .monster-trait > :last-child,
  .monster .monster-action > :last-child,
  .monster .monster-reaction > :last-child,
  .monster .monster-legendary-action > :last-child,
  .monster .monster-lair-action > :last-child {
    margin-bottom: 0; }
  .monster .lair-initiative,
  .monster .legendary-per-round,
  .monster .paragon-actions {
    font-size: 0.8em;
    font-style: italic; }
  .monster .monster-notes + * {
    margin-top: 0.57em; }
  .monster hr + .h5-border {
    display: none; }
  .monster .monster-footer {
    font-style: italic;
    opacity: 0.5;
    font-size: 0.8em; }
  .monster .line-break {
    display: block;
    height: 0.57em; }
  .monster .h5-border {
    min-height: 1px;
    height: 0.0714em;
    background: linear-gradient(to right, rgba(154, 21, 21, 0.75), rgba(154, 21, 21, 0));
    display: block;
    -webkit-print-color-adjust: exact;
    margin-top: 0;
    margin-bottom: 0.52em; }
    .monster .h5-border.notes {
      margin-top: 0.52em;
      height: 0.2143em; }
  .customization-menu .card-body {
      background-color: #eeeeee; }
  @media print {
    a { 
      color: black;
      text-decoration: none !important; }
    .monster {
      border-width: 2px;
      border-top-width: 5px;
      border-bottom-width: 5px;
    }
    .customization-menu {
      display: none; } }
  @media screen and (max-width: 459px) {
    .monster.columns-1 {
      font-size: 0.75rem; } }
  @media print {
      .monster.columns-1 {
        font-size: 1em; } }
  .monster.columns-2 {
    width: 70%;
    font-size: .9em; }
    @media print {
      .monster.columns-2 {
        width: 100%;
        font-size: 0.9em; } }
    @media screen and (max-width: 1200px) {
      .monster.columns-2 {
        width: 75% } }
    @media screen and (max-width: 1095px) {
      .monster.columns-2 {
        width: 80% } }
    @media screen and (max-width: 980px) {
      .monster.columns-2 {
        width: 85%; } }
    @media screen and (max-width: 880px) {
      .monster.columns-2 {
        width: 95%; } }
    @media screen and (max-width: 800px) {
      .monster.columns-2 {
        width: 100%; } }
    @media screen and (max-width: 720px) {
      .monster.columns-2 {
        font-size: 0.8rem; } }
    @media screen and (max-width: 620px) {
      .monster.columns-2 {
        font-size: 0.7rem; } }
    @media screen and (max-width: 535px) {
      .monster.columns-2 {
        font-size: 0.6rem; } }
    .monster.columns-2 .monster-contents-body {
      column-count: 2;
      column-gap: 1.42em; }
  .monster .h5-traits {
    display: none; }
    .monster .h5-traits + .h5-border {
      display: none; }
      .monster .h5-traits + .h5-border + .monster-trait {
        margin-top: 0.57em; }
</style>

</html>